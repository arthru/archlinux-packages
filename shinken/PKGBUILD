# Maintainer: Massimiliano Torromeo <massimiliano.torromeo@gmail.com>
# Contributor: Julien "Adyxax" Dessaux <judessaux@gmail.com>

pkgname=shinken
pkgver=2.0_RC7
pkgrel=1
pkgdesc='An open source Nagios® like tool, redesigned and rewritten from scratch. Its main goal is to meet today’s system monitoring requirements while still following compatibility to Nagios®'
arch=('any')
url='http://www.shinken-monitoring.org/'
license=('GPL3')
depends=('python2-pyro')
makedepends=('python2-setuptools' 'python2-sphinx')
optdepends=('nagios-plugins: various monitoring checks'
            'nagcon: a simple yet great curses interface over nagios style status.dat file'
            'python-pysqlite: for the livestatus module'
            'python-simplejson: for the livestatus module')
install='shinken.install'
source=("https://pypi.python.org/packages/source/S/Shinken/Shinken-${pkgver//_/-}.tar.gz"
        'shinken.install'
        'shinken.logrotate'
        'shinken.tmpfiles'
        'shinken-arbiter.service'
        'shinken-broker.service'
        'shinken-poller.service'
        'shinken-reactionner.service'
        'shinken-receiver.service'
        'shinken-scheduler.service'
        'setup.cfg')

prepare() {
	cd "$srcdir/Shinken-${pkgver//_/-}"
	find -name '*.py' -exec sed -i 's|^#!/usr/bin/env python2.6$|#!/usr/bin/env python2.7|' {} \;
}

build() {
	cd "$srcdir/Shinken-${pkgver//_/-}"
	cp -f "$srcdir/setup.cfg" .
	python2 setup.py build

	msg2 "Building docs"
	cd doc
	sphinx-build2 -b man -d build/doctrees/ source/ build/man/
}

package() {
	cd "$srcdir/Shinken-${pkgver//_/-}"

	python2 setup.py install --skip-build -O1 --root="$pkgdir"

	cd "$pkgdir"
	install -dm0755 var/lib/shinken/rw

	# man
	install -dm0755 usr/share/man
	mv var/lib/shinken/doc/build/man usr/share/man/man1

	# cleanup
	rm -rf var/lib/shinken/doc etc/init.d

	cd "$srcdir"

	# logrotate
	install -Dm0644 shinken.logrotate "$pkgdir/etc/logrotate.d/shinken"

	# systemd
	install -Dm0644 shinken.tmpfiles "$pkgdir/usr/lib/tmpfiles.d/shinken.conf"
	for service in *.service; do
	    install -Dm0644 $service "$pkgdir/usr/lib/systemd/system/$service"
	done
}

sha256sums=('bb8bc83c0eb84a46d3c6a43bc0dc9abd5a5be6e3e92c49e0d3bc999456c1611c'
            '9c7ae7a0187cbaebeaac5629fa44666f1dace35800617bdf2d70cf2f23ee8e97'
            'fb460d2c790093d3737dea62ac632df80293a58c983e8f837b968f5c3490cdd5'
            'e0f4017bd5f270909cd668279b64f09a73674ead3f1d0e29f11ec392397b9b71'
            '04e6391215d6a5db91cfd4fcf847f42632af03b5faac93fe09b648ddbf75cc78'
            'af1af6bafd945e8e24fcb9117116e2d2c10932c30f062240f2c508b0301bfaec'
            'cb5f8ecff6c7995165cac5097f72d079ecc28c9d45e690e2c74ccb052899d675'
            'f7f9ab3939edf23ce9d4801e3db0fc2d43ac78512bbe74b6cbdb159469426881'
            '160ca93ad4157127cebbb6ca6f0b94ba673e200e496a88e650792b3d6ea527a4'
            'e4d0c110929bed4a59570e4ed7062f1b3061218aa5308ce14faa33bc58b4b4b6'
            'e58d8b4244f4995c463f10a5975854cdaaf5c27b55a23a47ef1a81f02fdda2c0')
